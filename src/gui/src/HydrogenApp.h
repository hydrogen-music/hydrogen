/*
 * Hydrogen
 * Copyright(c) 2002-2008 by Alex >Comix< Cominu [comix@users.sourceforge.net]
 *
 * http://www.hydrogen-music.org
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY, without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 */

#ifndef HYDROGEN_APP_H
#define HYDROGEN_APP_H

#include <hydrogen/config.h>
#include <hydrogen/object.h>
#include <hydrogen/globals.h>

#include "EventListener.h"

#include <iostream>
#include <vector>
#include <QtGui>
#if QT_VERSION >= 0x050000
#  include <QtWidgets>
#endif
 #include <QStringList>

//#include <QUndoStack>

/** Amount of time to pass between successive calls to
 * HydrogenApp::onEventQueueTimer() in milliseconds.
 *
 * This causes the GUI to update at 20 frames per second.*/
#define QUEUE_TIMER_PERIOD 50


namespace H2Core
{
	class Song;
}

class SongEditorPanel;
class MainForm;
class PlayerControl;
class PatternEditorPanel;
class InstrumentEditorPanel;
class SongEditor;
class Mixer;
class AudioEngineInfoForm;
class SimpleHTMLBrowser;
class LadspaFXProperties;
class LadspaFXInfo;
class LadspaFXGroup;
class InstrumentRack;
class PlaylistDialog;
class SampleEditor;
class Director;
class InfoBar;

class HydrogenApp : public QObject, public H2Core::Object
{
		H2_OBJECT
	Q_OBJECT
	public:
		HydrogenApp( MainForm* pMainForm, H2Core::Song *pFirstSong );

		/// Returns the instance of HydrogenApp class
		static HydrogenApp* get_instance();

		virtual ~HydrogenApp();

		void setSong( H2Core::Song* pSong );

		void showPreferencesDialog();
		void updateMixerCheckbox();
		void showMixer(bool bShow);
		void showInstrumentPanel(bool);
		void showAudioEngineInfoForm();
		void showPlaylistDialog();
		void showDirector();
		void showSampleEditor( QString name, int mSelectedComponemt, int mSelectedLayer );

		Mixer*				getMixer();
		MainForm*			getMainForm();
		SongEditorPanel*		getSongEditorPanel();
		AudioEngineInfoForm*		getAudioEngineInfoForm();
		PlaylistDialog*			getPlayListDialog();
		Director*			getDirector();
		SampleEditor*			getSampleEditor();
		SimpleHTMLBrowser*		getHelpBrowser();
		PatternEditorPanel*		getPatternEditorPanel();
		PlayerControl*			getPlayerControl();
		InstrumentRack*			getInstrumentRack();
		InfoBar *			getInfoBar() const;

		QUndoStack*			m_pUndoStack;

		void setStatusBarMessage( const QString& msg, int msec = 0 );
		void setScrollStatusBarMessage( const QString& msg, int msec = 0, bool test = true );
		void updateWindowTitle();

#ifdef H2CORE_HAVE_LADSPA
		LadspaFXProperties* getLadspaFXProperties(uint nFX) {	return m_pLadspaFXProperties[nFX];	}
#endif
		void addEventListener( EventListener* pListener );
		void removeEventListener( EventListener* pListener );
		void closeFXProperties();

		void onDrumkitLoad( QString name );
		void enableDestructiveRecMode();

		void cleanupTemporaryFiles();

	public slots:
		/**
		 * Function called every #QUEUE_TIMER_PERIOD
		 * millisecond to pop all Events from the EventQueue
		 * and invoke the corresponding functions.
		 *
		 * Depending on the H2Core::EventType, the following members
		 * of EventListener will be called:
		 * - H2Core::EVENT_STATE -> 
		     EventListener::stateChangedEvent()
		 * - H2Core::EVENT_PATTERN_CHANGED -> 
		     EventListener::patternChangedEvent()
		 * - H2Core::EVENT_PATTERN_MODIFIED -> 
		     EventListener::patternModifiedEvent()
		 * - H2Core::EVENT_SONG_MODIFIED -> 
		     EventListener::songModifiedEvent()
		 * - H2Core::EVENT_SELECTED_PATTERN_CHANGED -> 
		     EventListener::selectedPatternChangedEvent()
		 * - H2Core::EVENT_SELECTED_INSTRUMENT_CHANGED -> 
		     EventListener::selectedInstrumentChangedEvent()
		 * - H2Core::EVENT_PARAMETERS_INSTRUMENT_CHANGED -> 
		     EventListener::parametersInstrumentChangedEvent()
		 * - H2Core::EVENT_MIDI_ACTIVITY -> 
		     EventListener::midiActivityEvent()
		 * - H2Core::EVENT_NOTEON -> 
		     EventListener::noteOnEvent()
		 * - H2Core::EVENT_ERROR -> 
		     EventListener::errorEvent()
		 * - H2Core::EVENT_XRUN -> 
		     EventListener::XRunEvent()
		 * - H2Core::EVENT_METRONOME -> 
		     EventListener::metronomeEvent()
		 * - H2Core::EVENT_RECALCULATERUBBERBAND -> 
		     EventListener::rubberbandbpmchangeEvent()
		 * - H2Core::EVENT_PROGRESS -> 
		     EventListener::progressEvent()
		 * - H2Core::EVENT_JACK_SESSION -> 
		     EventListener::jacksessionEvent()
		 * - H2Core::EVENT_PLAYLIST_LOADSONG -> 
		     EventListener::playlistLoadSongEvent()
		 * - H2Core::EVENT_UNDO_REDO -> 
		     EventListener::undoRedoActionEvent()
		 * - H2Core::EVENT_TEMPO_CHANGED -> 
		     EventListener::tempoChangedEvent()
		 * - H2Core::EVENT_UPDATE_SONG -> 
		     EventListener::updateSongEvent()
		 * - H2Core::EVENT_NONE -> nothing
		 *
		 * In addition, all MIDI notes in
		 * H2Core::EventQueue::m_addMidiNoteVector will converted into
		 * actions via SE_addNoteAction() and deleted from the
		 * former array.
		*/
		void onEventQueueTimer();
		void currentTabChanged(int);

	private:
		static HydrogenApp *		m_pInstance;	///< HydrogenApp instance

#ifdef H2CORE_HAVE_LADSPA
		LadspaFXProperties *		m_pLadspaFXProperties[MAX_FX];
#endif

		MainForm *			m_pMainForm;
		Mixer *				m_pMixer;
		PatternEditorPanel*		m_pPatternEditorPanel;
		AudioEngineInfoForm *		m_pAudioEngineInfoForm;
		SongEditorPanel *		m_pSongEditorPanel;
		SimpleHTMLBrowser *		m_pHelpBrowser;
		SimpleHTMLBrowser *		m_pFirstTimeInfo;
		InstrumentRack*			m_pInstrumentRack;
		PlayerControl *			m_pPlayerControl;
		PlaylistDialog *		m_pPlaylistDialog;
		SampleEditor *			m_pSampleEditor;
		InfoBar *			m_pInfoBar;
		Director *			m_pDirector;
		QTimer *			m_pEventQueueTimer;
		std::vector<EventListener*> 	m_EventListeners;
		QTabWidget *			m_pTab;
		QSplitter *			m_pSplitter;

		// implement EngineListener interface
		void engineError(uint nErrorCode);

		void setupSinglePanedInterface();
		virtual void songModifiedEvent();

		/**
		 * Refreshes and updates the GUI after the Song was changed in
		 * the core part of Hydrogen.
		 *
		 * When using session management or changing the Song using
		 * an OSC message, this command will get core and GUI in sync
		 * again. 
		 *
		 * \param nValue unused
		 */
		virtual void updateSongEvent( int nValue );
};


inline Mixer* HydrogenApp::getMixer()
{
	return m_pMixer;	
}

inline MainForm* HydrogenApp::getMainForm()
{	
	return m_pMainForm;	
}

inline SongEditorPanel* HydrogenApp::getSongEditorPanel()
{
	return m_pSongEditorPanel;
}

inline AudioEngineInfoForm* HydrogenApp::getAudioEngineInfoForm()
{
	return m_pAudioEngineInfoForm;
}

inline PlaylistDialog* HydrogenApp::getPlayListDialog()
{
	return m_pPlaylistDialog;
}

inline Director* HydrogenApp::getDirector()
{
	return m_pDirector;
}

inline SampleEditor* HydrogenApp::getSampleEditor()
{
	return m_pSampleEditor;	
}

inline SimpleHTMLBrowser* HydrogenApp::getHelpBrowser()
{
	return m_pHelpBrowser;
}

inline PatternEditorPanel* HydrogenApp::getPatternEditorPanel()
{
	return m_pPatternEditorPanel;
}

inline PlayerControl* HydrogenApp::getPlayerControl()
{
	return m_pPlayerControl;
}

inline InstrumentRack* HydrogenApp::getInstrumentRack()
{
	return m_pInstrumentRack;
}

inline InfoBar* HydrogenApp::getInfoBar() const
{
	return m_pInfoBar;
}

#endif
